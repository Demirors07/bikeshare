{% extends 'core/base.html' %}

{% block title %}Ana Sayfa | BikeShare{% endblock %}

{% block content %}
    <div class="text-center">
        <h1>Bisiklet Ã–dÃ¼nÃ§ Alma Sistemine HoÅŸ Geldiniz ðŸš²</h1>
        <p>{{ request.method }}</p>
        <p>{{ request.POST }}</p>
        <p>{{ request.GET }}</p>
        <p>{{ request.content_type }}</p>
        <p>{{ request.encoding }}</p>
        <p>{{ request.scheme }}</p>
        <p>{{ request.resolver_match }}</p>

        <p class="lead">Åžehir iÃ§inde hÄ±zlÄ±, ekonomik ve Ã§evreci ulaÅŸÄ±m!</p>
        <a href="{% url 'booking_create' %}" class="btn btn-success btn-lg mt-3" data-bs-toggle="modal" data-bs-target="#bookingModal">
            SÃ¼rmeye baÅŸla</a>
    </div>
<!-- Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bookingModalLabel">Bisiklet Rezervasyonu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div id="modal-form-content">
          <!-- Form AJAX ile buraya yÃ¼klenecek -->
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
document.addEventListener("DOMContentLoaded", function () {
  const bookingModalEl = document.getElementById('bookingModal');
  const bookingModal = new bootstrap.Modal(bookingModalEl);

  // Butona tÄ±klanÄ±nca formu AJAX ile Ã§ek
  document.querySelector('[data-bs-target="#bookingModal"]').addEventListener('click', (e) => {
    e.preventDefault();

  if (!isAuthenticated) {
  const nextUrl = "{{ request.path }}";
  window.location.href = "{% url 'login' %}?next=" + encodeURIComponent(nextUrl);
  return;
}

    fetch("{% url 'booking_create' %}")
      .then(response => response.json())
      .then(data => {
        document.getElementById("modal-form-content").innerHTML = data.html;
        attachFormSubmit();  // Submit iÅŸleyici
        bookingModal.show(); // âœ… Modal'Ä± aÃ§
      });
  });

  function attachFormSubmit() {
    const form = document.getElementById("bookingForm");
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(form);

      fetch("{% url 'booking_create' %}", {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          bookingModal.hide();
          window.location.href = data.redirect_url;
        } else {
          document.getElementById("modal-form-content").innerHTML = data.html;
          attachFormSubmit();  // Tekrar baÄŸla
        }
      });
    });
  }
});
</script>
{% endblock %}




